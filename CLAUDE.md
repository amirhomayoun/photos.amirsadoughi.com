# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Hugo-based photo blog with automated photo processing. Photos live outside the git repository in `~/Pictures/albums/`, while Hugo only tracks a YAML manifest (`data/albums.yaml`). The system supports both local symlink-based storage and cloud storage (Cloudflare R2 or Backblaze B2).

## Architecture

### Photo Processing Pipeline

1. **Source**: Original photos stored in `~/Pictures/albums/<album-name>/`
2. **Processing**: `upload-photos.py` creates three sizes (original ≤4000px, medium 1600px, thumbnail 400px)
3. **Storage**: Processed photos saved to `~/Pictures/albums/<album-name>/{original,medium,thumbnail}/`
4. **Manifest**: Generated `data/albums.yaml` contains album metadata and photo URLs
5. **Access**: Local dev uses symlink `static/photos` → `~/Pictures/albums/`; production can use cloud URLs

### Key Design Decisions

**Separation of concerns**: Photos never enter git. Only the manifest (`data/albums.yaml`) and content files (`content/album/*.md`) are committed. This keeps the repository lightweight while supporting large photo collections.

**Dual storage modes**:
- **Local**: Symlink-based. Hugo serves photos from `~/Pictures/albums/` via `static/photos` symlink
- **Cloud**: Photos uploaded to R2/B2 during processing. URLs in manifest point to CDN

**Album ID sanitization**: Directory names can have spaces/special characters. The script converts them to URL-safe IDs (e.g., `Trip to Japan 2025` → `trip-to-japan-2025`). The album title (for display) can differ from the ID via `album.yaml`.

### Hugo Data Flow

1. **Home page** (`layouts/index.html`): Reads `data/albums.yaml`, displays album grid using first photo as cover
2. **Album page** (`layouts/album/single.html`): Matches content file basename (`content/album/<id>.md`) to album ID in `data/albums.yaml`, renders photo grid with EXIF data
3. **Content files**: Minimal markdown files auto-generated by processing script. Hugo's data files provide the actual content

## Common Commands

### Development Workflow
```bash
make process          # Smart process (only new/changed albums)
make process-all      # Force reprocess all albums
make serve            # Start Hugo dev server (with drafts)
make dev              # Process + serve (combined workflow)
make clean            # Remove Hugo build artifacts
make build            # Build for production
```

### Photo Management
```bash
make process-album ALBUM=album-name   # Process single album only
make git-status                       # Show albums and photo counts
make check                            # Verify dependencies installed
```

### Smart Processing

The script automatically detects which albums need processing and optimizes accordingly:

**Smart detection checks:**
- Do processed directories exist? (`original/`, `medium/`, `thumbnail/`)
- Do photo counts match between source and processed?
- Are the photo filenames identical?

**Behavior based on album state:**

| Album State | `make process` Action | Re-uploads to R2? |
|-------------|----------------------|-------------------|
| New album (no processed photos) | Full processing | ✅ Yes |
| Photos changed/added | Full processing | ✅ Yes |
| Photos unchanged | Metadata update only | ❌ No |

**Commands:**
- `make process` - Smart mode (recommended for daily use)
- `make process-all` - Force reprocess everything (use after config changes like image quality)
- `make process-album ALBUM=name` - Always processes specified album (force mode)

**Example workflows:**

```bash
# Add new album
mkdir ~/Pictures/albums/new-album
cp photos/*.jpg ~/Pictures/albums/new-album/
make process
# → New album: Full processing + upload

# Update metadata only (change title, add cover_photo, etc.)
vim ~/Pictures/albums/existing-album/album.yaml
make process
# → Existing album: Metadata update only (no re-upload!)

# Add more photos to existing album
cp more/*.jpg ~/Pictures/albums/existing-album/
make process
# → Existing album: Full processing + upload (photos changed)
```

### Testing
```bash
make test             # Validate configuration and build
make info             # Display site statistics
```

## Processing Script (`upload-photos.py`)

**Configuration**: Reads `.env` file for paths and settings. Key variables:
- `PHOTOS_DIR`: Location of albums (default: `~/Pictures/albums`)
- `USE_CLOUD_STORAGE`: `true` for R2/B2, `false` for local symlink
- `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`, `S3_BUCKET`, `CDN_BASE_URL`: Cloud storage credentials

**Album discovery**: Scans `PHOTOS_DIR` for subdirectories. Each directory with `.jpg/.jpeg/.png` files becomes an album.

**Metadata**: Optional `album.yaml` in album directory:
```yaml
title: "Custom Title"       # Overrides directory name
description: "..."
date: 2025-12-15
location: "City, Country"
tags: [tag1, tag2]
cover_photo: "IMG_1234.jpg" # Filename to use as album cover (defaults to first photo alphabetically)
```

**EXIF extraction**: Uses `exiftool` (optional) to extract camera, lens, focal length, aperture, shutter speed, ISO. Falls back gracefully if exiftool not installed.

**Output**: Writes `data/albums.yaml` with structure:
```yaml
albums:
  - id: album-slug
    title: "Album Title"
    date: "2025-12-15"
    photos:
      - id: filename-stem
        filename: photo.jpg
        urls:
          original: /photos/album-slug/original/photo.jpg
          medium: /photos/album-slug/medium/photo.jpg
          thumbnail: /photos/album-slug/thumbnail/photo.jpg
        exif: {...}
```

## Important Patterns

### When Working with Albums

**Adding new photos**: User adds photos to `~/Pictures/albums/<album>/`, then runs `make process`. Never manually edit `data/albums.yaml` or create content files—the script generates them.

**Album naming**: Directory names are converted to URL-safe IDs. Spaces and special characters removed/converted. The `title` field in `album.yaml` controls display name.

**Reprocessing**: It's safe to run `make process` repeatedly. The script regenerates all processed sizes and overwrites the manifest. Processed photos in album subdirectories are recreated if source photos changed.

### When Modifying Layouts

**Data access**: Use `.Site.Data.albums.albums` to iterate albums. Each album has `id`, `title`, `date`, `location`, `tags`, `photos[]`. Each photo has `urls.{original,medium,thumbnail}`, `exif`, `width`, `height`.

**URL structure**: Albums at `/album/<album-id>/`. Photo URLs depend on storage mode (local: `/photos/<album-id>/<size>/<filename>`, cloud: full CDN URLs).

**PhotoSwipe integration**: Album single page includes PhotoSwipe for lightbox. Photos need `data-pswp-width` and `data-pswp-height` attributes.

### Cloud Storage Migration

To switch from local to cloud:
1. Configure cloud credentials in `.env` (set `USE_CLOUD_STORAGE=true`)
2. Run `make process` (uploads to R2/B2 and updates manifest URLs)
3. Commit updated `data/albums.yaml`

The script handles both modes transparently—same Python code, different URL generation.

## File Organization

**Never modify**:
- `data/albums.yaml` (auto-generated)
- `content/album/*.md` (auto-generated)
- `static/photos/` (symlink, recreated by script)

**Config files**:
- `hugo.toml`: Site title, baseURL, params
- `.env`: Photo processing settings (not in git)
- `netlify.toml`: Build settings and cache headers

**Templates**:
- `layouts/index.html`: Home page (album grid)
- `layouts/album/single.html`: Album detail page (photo grid + EXIF)
- `layouts/_default/baseof.html`: Base template
- `layouts/partials/`: Shared components (head, footer)

**Static assets**:
- `static/css/style.css`: Custom styles
- `static/photos/`: Symlink to `~/Pictures/albums/` (local mode only)

## Deployment

**Netlify**: Push to git triggers build. Hugo version specified in `netlify.toml`. For local storage mode, photos must be in git (not recommended for production). For production, use cloud storage—Netlify builds fast HTML-only site.

**What gets committed**:
- All code (layouts, CSS, config)
- `data/albums.yaml` (manifest only, not actual photos)
- `content/album/*.md` (minimal frontmatter files)

**What stays local/cloud**:
- Photos in `~/Pictures/albums/` (never committed)
- Cloud storage: photos on R2/B2

## Environment Setup

**Dependencies**:
- Hugo 0.123.0+ (static site generator)
- Python 3.8+ (for processing script)
- Pillow (Python image library)
- PyYAML (Python YAML parser)
- exiftool (optional, for EXIF extraction)
- boto3 (optional, for cloud storage)

**Setup sequence**:
1. `make setup` (creates venv, installs dependencies, creates directories)
2. Configure `.env` (copy from `.env.example`)
3. Add photos to `~/Pictures/albums/<album-name>/`
4. `make process` (process photos and generate manifest)
5. `make serve` (preview site)
